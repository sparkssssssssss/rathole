name: Build Static Rathole for JDC-1

on:
  workflow_dispatch:  # 允许手动点击按钮触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: mipsel-unknown-linux-musl

      - name: Install Cross
        run: cargo install cross

      - name: Configure Static Linking
        run: |
          mkdir -p .cargo
          echo '[target.mipsel-unknown-linux-musl]' >> .cargo/config.toml
          echo 'rustflags = ["-C", "target-feature=+crt-static"]' >> .cargo/config.toml

      - name: Build for MIPS (Static & Embedded TLS)
        # 关键参数解释：
        # --no-default-features: 关闭默认功能（主要是为了关掉 OpenSSL）
        # --features "server client embedded-tls": 重新开启服务端客户端，并使用纯 Rust 的 TLS 库
        run: cross build --target mipsel-unknown-linux-musl --release --no-default-features --features "server client embedded-tls"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rathole-static-mips
          path: target/mipsel-unknown-linux-musl/release/rathole
