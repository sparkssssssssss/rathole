name: Build Static Rathole for JDC-1

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. 删除版本锁定，强制使用最新 Rust 编译器
      - name: Remove rust-toolchain version pin
        run: rm -f rust-toolchain rust-toolchain.toml

      # 2. 安装最新的稳定版 Rust
      - name: Install Rust (Latest Stable)
        uses: dtolnay/rust-toolchain@stable

      # 3. 快速安装 cross 工具（使用二进制源，几秒钟搞定）
      - name: Install Cross (Fast Method)
        run: |
          curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
          cargo binstall cross -y

      # 4. 配置静态编译参数（告诉编译器我们要生成独立运行的程序）
      - name: Configure Static Linking
        run: |
          mkdir -p .cargo
          echo '[target.mipsel-unknown-linux-musl]' >> .cargo/config.toml
          echo 'rustflags = ["-C", "target-feature=+crt-static"]' >> .cargo/config.toml

      # 5. 开始编译（修正了特性开关）
      # --no-default-features: 清空默认项
      # --features "server client noise": 只开启服务端、客户端和 noise 加密协议
      - name: Build for MIPS (Correct Features)
        run: cross build --target mipsel-unknown-linux-musl --release --no-default-features --features "server client noise"

      # 6. 上传结果
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rathole-static-mips
          path: target/mipsel-unknown-linux-musl/release/rathole
