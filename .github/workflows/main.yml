name: Build rathole for JD Cloud 1 (Padavan)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch: # 允许你在 Actions 页面手动点击运行

env:
  CARGO_TERM_COLOR: always

jobs:
  build-mipsel:
    name: Build for MT7621 (Padavan)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: mipsel-unknown-linux-musl

      - name: Install Cross
        uses: taiki-e/install-action@cross

      - name: Build for MIPS Little Endian (Static)
        # 核心命令解析：
        # --target mipsel-unknown-linux-musl: 对应 MT7621 芯片，且静态链接所有库
        # --no-default-features: 关掉默认的 OpenSSL
        # --features "server,client,hot-reload,noise,rustls": 重新开启功能并指定使用 rustls
        run: |
          cross build --target mipsel-unknown-linux-musl --release --no-default-features --features "server,client,hot-reload,noise,rustls"

      - name: Prepare Artifact
        run: |
          cd target/mipsel-unknown-linux-musl/release/
          # 重命名一下，方便识别
          mv rathole rathole-mipsel-mt7621

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rathole-mipsel-mt7621
          path: target/mipsel-unknown-linux-musl/release/rathole-mipsel-mt7621
