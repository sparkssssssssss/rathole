name: Build Static Rathole for JDC-1

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. 移除版本锁定
      - name: Remove rust-toolchain version pin
        run: rm -f rust-toolchain rust-toolchain.toml

      # 2. 安装 Rust Nightly 和 源码
      # 依然需要 Nightly 和 src 来重新编译标准库
      - name: Install Rust (Nightly + Source)
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src

      # 3. 安装 Zig 语言编译器 (它将作为我们的链接器)
      - name: Install Zig Toolchain
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      # 4. 安装 cargo-zigbuild 工具
      - name: Install Zigbuild
        run: cargo install cargo-zigbuild

      # 5. 编译！
      # 解释：
      # -Z build-std=std,panic_abort: 现场编译 Rust 标准库
      # --target mipsel-unknown-linux-musl: 目标架构
      # 这一步 Zig 会自动合成 crt1.o 等缺失文件
      - name: Build for MIPS (via Zigbuild)
        run: |
          cargo +nightly zigbuild --target mipsel-unknown-linux-musl --release \
          -Z build-std=std,panic_abort \
          --no-default-features --features "server client noise"

      # 6. 打包上传
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rathole-static-mips
          path: target/mipsel-unknown-linux-musl/release/rathole
