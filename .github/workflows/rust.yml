name: Build rathole for JD Cloud 1 (CPU Efficiency)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  # ----------------------------------------------------------------
  # CPU 效率优先配置
  # ----------------------------------------------------------------
  # 1. 开启 LTO: 必开，打通函数隔阂，减少函数跳转的 CPU 开销
  CARGO_PROFILE_RELEASE_LTO: true
  
  # 2. 核心改动：使用 Level 2
  #    Level 3 = 激进优化，代码膨胀，导致 MT7621 缓存溢出，性能反而下降
  #    Level 2 = 速度与体积的黄金平衡点，最适合嵌入式 CPU
  CARGO_PROFILE_RELEASE_OPT_LEVEL: 2
  
  # 3. 这里的 1 依然保留，确保编译器能看到全局视图进行优化
  CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 1
  
  # 4. 依然去掉 Panic，为了减少无用的分支预测，降低 CPU 负担
  CARGO_PROFILE_RELEASE_PANIC: abort
  CARGO_PROFILE_RELEASE_STRIP: true

jobs:
  build-mipsel-cpu-efficient:
    name: Build MIPS CPU Efficient
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Cross
        uses: taiki-e/install-action@cross

      - name: Build for MT7621 (1004Kc Optimized)
        # ----------------------------------------------------------------
        # 针对 MT7621 的核心微架构优化
        # ----------------------------------------------------------------
        # -C target-cpu=1004kc: 
        #    MT7621 的核心就是 1004Kc。这比 mips32r2 更精准。
        #    它会让编译器优化指令发射顺序，填满 CPU 的执行流水线，
        #    从而直接降低 CPU 等待时间（即降低 CPU 使用率）。
        # ----------------------------------------------------------------
        run: |
          RUSTFLAGS="-C target-feature=+crt-static -C target-cpu=1004kc" \
          cross build --target mipsel-unknown-linux-musl --release --no-default-features --features "server,client,hot-reload,noise,rustls"

      - name: Check binary
        run: |
          cd target/mipsel-unknown-linux-musl/release/
          ls -lh rathole
          mv rathole rathole-mipsel-mt7621-efficient

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rathole-mipsel-mt7621-efficient
          path: target/mipsel-unknown-linux-musl/release/rathole-mipsel-mt7621-efficient
