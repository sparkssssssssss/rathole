name: Build rathole for JD Cloud 1 (Max Performance)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  # ----------------------------------------------------------------
  # 极致优化设置 (通过环境变量覆盖 Cargo.toml，避免修改文件报错)
  # ----------------------------------------------------------------
  # 1. 开启 LTO (Link Time Optimization): 消除跨模块调用开销，对 MIPS 提升巨大
  CARGO_PROFILE_RELEASE_LTO: true
  # 2. 最高优化等级
  CARGO_PROFILE_RELEASE_OPT_LEVEL: 3
  # 3. 牺牲编译速度换取更好的机器码质量
  CARGO_PROFILE_RELEASE_CODEGEN_UNITS: 1
  # 4. 遇到错误直接退出，移除堆栈回溯，大幅减小体积
  CARGO_PROFILE_RELEASE_PANIC: abort
  # 5. 自动剥离符号表
  CARGO_PROFILE_RELEASE_STRIP: true

jobs:
  build-mipsel-optimized:
    name: Build MIPS Optimized
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Cross
        uses: taiki-e/install-action@cross

      - name: Build for MIPS32r2 (Static + Optimized)
        # ----------------------------------------------------------------
        # 针对 MT7621 芯片指令集优化
        # ----------------------------------------------------------------
        # -C target-feature=+crt-static: 强制静态链接 musl 库
        # -C target-cpu=mips32r2: 开启硬件位移指令优化 (MT7621 支持)
        # ----------------------------------------------------------------
        run: |
          RUSTFLAGS="-C target-feature=+crt-static -C target-cpu=mips32r2" \
          cross build --target mipsel-unknown-linux-musl --release --no-default-features --features "server,client,hot-reload,noise,rustls"

      - name: Check binary
        run: |
          cd target/mipsel-unknown-linux-musl/release/
          # 验证文件类型，预期结果应包含 "statically linked"
          file rathole
          # 重命名
          mv rathole rathole-mipsel-mt7621-optimized

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rathole-mipsel-mt7621-optimized
          path: target/mipsel-unknown-linux-musl/release/rathole-mipsel-mt7621-optimized
